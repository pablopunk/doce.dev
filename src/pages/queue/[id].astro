---
import { ErrorBoundary } from "@/components/error/ErrorBoundary";
import { JobDetailLive } from "@/components/queue/JobDetailLive";
import AppLayout from "@/layouts/AppLayout.astro";
import { canUserAccessQueueJob } from "@/server/queue/access";
import { getJobById } from "@/server/queue/queue.model";

const user = Astro.locals.user;
if (!user) {
	return Astro.redirect("/login");
}

const jobId = Astro.params.id;
if (!jobId) {
	return Astro.redirect("/queue");
}

const job = await getJobById(jobId);
if (!job) {
	return Astro.redirect("/queue");
}

const canAccessJob = await canUserAccessQueueJob(user.id, job);
if (!canAccessJob) {
	return Astro.redirect("/queue");
}
---

<AppLayout title={`Queue Job ${job.id}`}>
  <ErrorBoundary componentName="JobDetailLive" client:load>
    <JobDetailLive client:load initialJob={job} />
  </ErrorBoundary>
</AppLayout>

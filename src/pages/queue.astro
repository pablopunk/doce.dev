---
import AppLayout from "@/layouts/AppLayout.astro";
import { QueueTableLive } from "@/components/queue/QueueTableLive";
import { listJobs, isQueuePaused, getConcurrency } from "@/server/queue/queue.model";
import type { QueueJob } from "@/server/db/schema";

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/login");
}

const search = Astro.url.searchParams;

const stateParam = search.get("state") ?? "";
const typeParam = search.get("type") ?? "";
const projectIdParam = search.get("projectId") ?? "";
const qParam = search.get("q") ?? "";

const allowedStates = ["queued", "running", "succeeded", "failed", "cancelled"] as const;
const state = allowedStates.includes(stateParam as (typeof allowedStates)[number])
  ? (stateParam as QueueJob["state"])
  : undefined;

const allowedTypes = [
  "project.delete",
  "projects.deleteAllForUser",
  "docker.ensureRunning",
  "docker.stop",
] as const;
const type = allowedTypes.includes(typeParam as (typeof allowedTypes)[number])
  ? (typeParam as QueueJob["type"])
  : undefined;

const paused = await isQueuePaused();
const concurrency = await getConcurrency();

const jobs = await listJobs({
  state: state ?? undefined,
  type: type as any,
  projectId: projectIdParam || undefined,
  q: qParam || undefined,
  limit: 100,
} as any);

const filters = {
  state: stateParam ? stateParam : undefined,
  type: typeParam ? typeParam : undefined,
  projectId: projectIdParam ? projectIdParam : undefined,
  q: qParam ? qParam : undefined,
};
---

<AppLayout title="Queue">
  <QueueTableLive client:load initialJobs={jobs} initialPaused={paused} initialConcurrency={concurrency} filters={filters} />
</AppLayout>

---
import { QueueTableLive } from "@/components/queue/QueueTableLive";
import AppLayout from "@/layouts/AppLayout.astro";
import type { QueueJob } from "@/server/db/schema";
import {
	countJobs,
	getConcurrency,
	isQueuePaused,
	listJobs,
} from "@/server/queue/queue.model";

const user = Astro.locals.user;
if (!user) {
	return Astro.redirect("/login");
}

const search = Astro.url.searchParams;

const stateParam = search.get("state") ?? "";
const typeParam = search.get("type") ?? "";
const projectIdParam = search.get("projectId") ?? "";
const qParam = search.get("q") ?? "";
const pageParam = search.get("page") ?? "1";

const allowedStates = [
	"queued",
	"running",
	"succeeded",
	"failed",
	"cancelled",
] as const;
const state = allowedStates.includes(
	stateParam as (typeof allowedStates)[number],
)
	? (stateParam as QueueJob["state"])
	: undefined;

const allowedTypes = [
	"project.delete",
	"projects.deleteAllForUser",
	"docker.ensureRunning",
	"docker.stop",
] as const;
const type = allowedTypes.includes(typeParam as (typeof allowedTypes)[number])
	? (typeParam as QueueJob["type"])
	: undefined;

const pageSize = 25;
const page = Math.max(1, parseInt(pageParam, 10) || 1);
const offset = (page - 1) * pageSize;

const paused = await isQueuePaused();
const concurrency = await getConcurrency();

const jobs = await listJobs({
	state: state ?? undefined,
	type,
	projectId: projectIdParam || undefined,
	q: qParam || undefined,
	limit: pageSize,
	offset,
});

const totalCount = await countJobs({
	state: state ?? undefined,
	type,
	projectId: projectIdParam || undefined,
	q: qParam || undefined,
});

const totalPages = Math.ceil(totalCount / pageSize);

const filters = {
	state: stateParam ? stateParam : undefined,
	type: typeParam ? typeParam : undefined,
	projectId: projectIdParam ? projectIdParam : undefined,
	q: qParam ? qParam : undefined,
};

const pagination = {
	page,
	pageSize,
	totalCount,
	totalPages,
};
---

<AppLayout title="Queue">
  <QueueTableLive client:load initialJobs={jobs} initialPage={page} initialPagination={pagination} initialPaused={paused} initialConcurrency={concurrency} filters={filters} />
</AppLayout>

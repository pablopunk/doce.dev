---
import AppLayout from "@/layouts/AppLayout.astro";
import { listJobs, isQueuePaused } from "@/server/queue/queue.model";
import type { QueueJob } from "@/server/db/schema";

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/login");
}

const search = Astro.url.searchParams;

const stateParam = search.get("state") ?? "";
const typeParam = search.get("type") ?? "";
const projectIdParam = search.get("projectId") ?? "";
const qParam = search.get("q") ?? "";

const allowedStates = ["queued", "running", "succeeded", "failed", "cancelled"] as const;
const state = allowedStates.includes(stateParam as (typeof allowedStates)[number])
  ? (stateParam as QueueJob["state"])
  : undefined;

const allowedTypes = [
  "project.delete",
  "projects.deleteAllForUser",
  "docker.ensureRunning",
  "docker.stop",
] as const;
const type = allowedTypes.includes(typeParam as (typeof allowedTypes)[number])
  ? (typeParam as QueueJob["type"])
  : undefined;

const paused = await isQueuePaused();

const jobs = await listJobs({
  state: state ?? undefined,
  type: type as any,
  projectId: projectIdParam || undefined,
  q: qParam || undefined,
  limit: 100,
} as any);

const hasActive = jobs.some((j) => j.state === "running");
---

<AppLayout title="Queue">
  <div class="px-8 py-6 max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-semibold">Queue</h1>
      <button data-queue-toggle class="px-4 py-2 rounded bg-primary text-primary-foreground hover:bg-primary/80">
        {paused ? "Paused" : "Running"}
      </button>
    </div>
    
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b">
            <th class="text-left py-2 px-2">ID</th>
            <th class="text-left py-2 px-2">Type</th>
            <th class="text-left py-2 px-2">State</th>
            <th class="text-left py-2 px-2">Project</th>
            <th class="text-left py-2 px-2">Created</th>
            <th class="text-left py-2 px-2">Actions</th>
          </tr>
        </thead>
        <tbody>
          {jobs.map((job) => (
            <tr class="border-b hover:bg-muted/50">
              <td class="py-2 px-2 font-mono text-xs">{job.id.slice(0, 8)}</td>
              <td class="py-2 px-2">{job.type}</td>
              <td class="py-2 px-2">
                <span class={`px-2 py-1 rounded text-xs ${
                  job.state === "succeeded" ? "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100" :
                  job.state === "failed" ? "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100" :
                  job.state === "running" ? "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100" :
                  "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100"
                }`}>
                  {job.state}
                </span>
              </td>
              <td class="py-2 px-2 text-xs text-muted-foreground">{job.projectId}</td>
              <td class="py-2 px-2 text-xs text-muted-foreground">{new Date(job.createdAt).toLocaleString()}</td>
              <td class="py-2 px-2 space-x-2 flex">
                {job.state === "queued" && (
                  <button data-action="runNow" data-job-id={job.id} class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">Run Now</button>
                )}
                {(job.state === "queued" || job.state === "running") && (
                  <button data-action="cancel" data-job-id={job.id} class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">Cancel</button>
                )}
                {job.state === "failed" && (
                  <button data-action="retry" data-job-id={job.id} class="px-2 py-1 text-xs bg-yellow-500 text-white rounded hover:bg-yellow-600">Retry</button>
                )}
                {job.state === "running" && (
                  <button data-action="forceUnlock" data-job-id={job.id} class="px-2 py-1 text-xs bg-orange-500 text-white rounded hover:bg-orange-600">Force Unlock</button>
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>
</AppLayout>

<script define:vars={{ hasActive }} is:inline>
  const request = async (action, data) => {
    const res = await fetch(action, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });

    const payload = await res.json().catch(() => ({}));
    const resultData = Array.isArray(payload) ? payload[0] : payload.data;
    const error = Array.isArray(payload) ? payload[1] : payload.error;

    if (!res.ok || (resultData && resultData.success === false) || error) {
      throw new Error(error?.message ?? "Request failed");
    }
  };

  document.addEventListener("click", async (e) => {
    const target = e.target;
    if (!(target instanceof HTMLElement)) return;

    const toggle = target.closest("[data-queue-toggle]");
    if (toggle) {
      const paused = toggle.textContent?.includes("Paused");
      const action = paused ? "/_actions/queue.resume" : "/_actions/queue.pause";
      try {
        await request(action);
        window.location.reload();
      } catch (err) {
        alert(err instanceof Error ? err.message : "Failed");
      }
      return;
    }

    const btn = target.closest("[data-action]");
    if (!btn) return;

    const action = btn.getAttribute("data-action");
    const jobId = btn.getAttribute("data-job-id");
    if (!action || !jobId) return;

    if (action === "forceUnlock") {
      if (!confirm("Force unlock is destructive. Continue?")) return;
    }

    if (action === "cancel") {
      if (!confirm("Cancel this job?")) return;
    }

    try {
      if (action === "cancel") {
        await request("/_actions/queue.cancel", { jobId });
      } else if (action === "retry") {
        await request("/_actions/queue.retry", { jobId });
      } else if (action === "runNow") {
        await request("/_actions/queue.runNow", { jobId });
      } else if (action === "forceUnlock") {
        await request("/_actions/queue.forceUnlock", { jobId });
      }

      window.location.reload();
    } catch (err) {
      alert(err instanceof Error ? err.message : "Failed");
    }
  });

  if (hasActive) {
    setTimeout(() => {
      window.location.reload();
    }, 4000);
  }
</script>

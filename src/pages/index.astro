---
import AppLayout from "@/layouts/AppLayout.astro";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Settings, Plus, Loader2 } from "lucide-react";
import { ProjectCard } from "@/components/projects/ProjectCard";
import { getProjectsByUserId } from "@/server/projects/projects.model";
import { AVAILABLE_MODELS, DEFAULT_MODEL } from "@/server/settings/openrouter";
import { db } from "@/server/db/client";
import { userSettings } from "@/server/db/schema";
import { eq } from "drizzle-orm";
import { actions } from "astro:actions";

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/login");
}

// Get user's projects
const projects = await getProjectsByUserId(user.id);

// Get user's default model
const settings = await db
  .select()
  .from(userSettings)
  .where(eq(userSettings.userId, user.id))
  .limit(1);
const defaultModel = settings[0]?.defaultModel ?? DEFAULT_MODEL;

// Handle form submission result
const result = Astro.getActionResult(actions.projects.create);
const formError = result?.error?.message;
const formSuccess = result?.data?.success;
const newProject = result?.data?.project;

// If project was created, redirect to it
if (formSuccess && newProject) {
  return Astro.redirect(`/projects/${newProject.id}/${newProject.slug}`);
}
---

<AppLayout title="Dashboard">
  <main class="container mx-auto p-8">
    <div class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold">doce.dev</h1>
        <p class="text-muted-foreground">Delicious Open Code Environments</p>
      </div>
      <a href="/settings">
        <Button variant="ghost" size="icon">
          <Settings className="h-5 w-5" />
        </Button>
      </a>
    </div>

    <Card className="mb-8">
      <CardHeader>
        <CardTitle>Create a new project</CardTitle>
        <CardDescription>
          Describe your website and let AI build it for you.
        </CardDescription>
      </CardHeader>
       <CardContent>
         <form method="post" action={actions.projects.create} class="space-y-4" id="create-form">
           <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
             <input
               type="text"
               name="prompt"
               placeholder="A landing page for my SaaS product..."
               required
               class="flex-1 rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
             />
             <select
               name="model"
               class="rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
             >
               {AVAILABLE_MODELS.map((model) => (
                 <option value={model.id} selected={model.id === defaultModel}>
                   {model.name} ({model.provider})
                 </option>
               ))}
             </select>
             <Button type="submit" id="submit-btn" size="lg">
               <Plus />
               <span id="btn-text">Create Project</span>
               <Loader2 className="animate-spin hidden" id="btn-loader" />
             </Button>
           </div>
           {formError && (
             <p class="text-sm text-destructive">{formError}</p>
           )}
         </form>
       </CardContent>
    </Card>

    <div>
      <h2 class="mb-4 text-xl font-semibold">Your Projects</h2>
      {projects.length === 0 ? (
        <div class="rounded-lg border border-dashed border-muted-foreground/25 p-8 text-center">
          <p class="text-muted-foreground">No projects yet. Create one above to get started!</p>
        </div>
      ) : (
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="projects-grid">
          {projects.map((project) => (
            <div data-project-id={project.id}>
              <ProjectCard project={project} client:load />
            </div>
          ))}
        </div>
      )}
    </div>
  </main>
</AppLayout>

<script>
  // Handle form submission loading state
  const form = document.getElementById('create-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const btnText = document.getElementById('btn-text');
  const btnLoader = document.getElementById('btn-loader');

  form?.addEventListener('submit', () => {
    submitBtn.disabled = true;
    btnText?.classList.add('hidden');
    btnLoader?.classList.remove('hidden');
  });

  // Handle project deletion (optimistic UI)
  document.addEventListener('click', async (e) => {
    const target = e.target as HTMLElement;
    const deleteBtn = target.closest('[data-delete-project]') as HTMLElement;
    if (!deleteBtn) return;

    const projectId = deleteBtn.dataset.deleteProject;
    if (!projectId) return;

    if (!confirm('Are you sure you want to delete this project?')) return;

    // Optimistically remove from UI
    const projectCard = document.querySelector(`[data-project-id="${projectId}"]`);
    projectCard?.classList.add('opacity-50', 'pointer-events-none');

    try {
      const response = await fetch('/_actions/projects.delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ projectId }),
      });

      if (response.ok) {
        projectCard?.remove();
      } else {
        // Revert on error
        projectCard?.classList.remove('opacity-50', 'pointer-events-none');
        alert('Failed to delete project');
      }
    } catch {
      projectCard?.classList.remove('opacity-50', 'pointer-events-none');
      alert('Failed to delete project');
    }
  });
</script>

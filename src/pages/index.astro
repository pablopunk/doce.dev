---
import AppLayout from "@/layouts/AppLayout.astro";
import HeroSection from "@/components/dashboard/HeroSection.astro";
import { CreateProjectForm } from "@/components/dashboard/CreateProjectForm";
import { ProjectsList } from "@/components/projects/ProjectsList";
import { getProjectsByUserId } from "@/server/projects/projects.model";
import { AVAILABLE_MODELS, DEFAULT_MODEL } from "@/server/settings/openrouter";
import { db } from "@/server/db/client";
import { userSettings as userSettingsTable } from "@/server/db/schema";
import { eq } from "drizzle-orm";

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/login");
}

// Get user's projects for SSR
const projects = await getProjectsByUserId(user.id);

// Get user's default model
const userSettings = await db
  .select()
  .from(userSettingsTable)
  .where(eq(userSettingsTable.userId, user.id))
  .limit(1);
const defaultModel = userSettings[0]?.defaultModel ?? DEFAULT_MODEL;
---

<AppLayout title="Dashboard">
  <HeroSection>
    <CreateProjectForm client:load models={AVAILABLE_MODELS} defaultModel={defaultModel} />
  </HeroSection>

  <ProjectsList fallback={projects} client:load />
</AppLayout>

---
import { eq } from "drizzle-orm";
import { CreateProjectForm } from "@/components/dashboard/CreateProjectForm";
import HeroSection from "@/components/dashboard/HeroSection.astro";
import { ProjectsList } from "@/components/projects/ProjectsList";
import AppLayout from "@/layouts/AppLayout.astro";
import { db } from "@/server/db/client";
import { userSettings as userSettingsTable } from "@/server/db/schema";
import { logger } from "@/server/logger";
import { listConnectedProviderIds } from "@/server/opencode/authFile";
import { getProjectsByUserId } from "@/server/projects/projects.model";

const user = Astro.locals.user;
if (!user) {
	// Middleware should have redirected to /login or /setup
	// This is a safety fallback
	return Astro.redirect("/login");
}

// Get user's projects for SSR
const projects = await getProjectsByUserId(user.id);

// Get user's default model from settings
const userSettings = await db
	.select()
	.from(userSettingsTable)
	.where(eq(userSettingsTable.userId, user.id))
	.limit(1);
const settingsDefaultModel = userSettings[0]?.defaultModel;

// Get connected provider IDs
const connectedProviderIds = await listConnectedProviderIds();

// Get available models from connected providers
let allModels: Array<{
	id: string;
	name: string;
	provider: string;
	vendor: string;
	supportsImages?: boolean;
}> = [];

try {
	const { getAvailableModels } = await import("@/server/opencode/models");
	const { modelSupportsVision } = await import("@/server/opencode/models");

	const availableModels = await getAvailableModels(connectedProviderIds);

	allModels = await Promise.all(
		availableModels.map(async (model) => ({
			id: model.id,
			name: model.name,
			provider: model.provider,
			vendor: model.vendor,
			supportsImages: await modelSupportsVision(model.id),
		})),
	);
} catch (error) {
	logger.error({ error }, "Failed to load models");
	// Fallback to empty array
}
---

<AppLayout title="Dashboard">
  <HeroSection>
    <CreateProjectForm client:load models={allModels} defaultModel={(settingsDefaultModel || undefined) as string | undefined} />
  </HeroSection>

  <ProjectsList fallback={projects} client:load />
</AppLayout>

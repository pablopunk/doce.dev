---
import { eq } from "drizzle-orm";
import { CreateProjectForm } from "@/components/dashboard/CreateProjectForm";
import HeroSection from "@/components/dashboard/HeroSection.astro";
import { ProjectsList } from "@/components/projects/ProjectsList";
import AppLayout from "@/layouts/AppLayout.astro";
import { db } from "@/server/db/client";
import { userSettings as userSettingsTable } from "@/server/db/schema";
import { getProjectsByUserId } from "@/server/projects/projects.model";
import { listConnectedProviderIds } from "@/server/opencode/authFile";
import { modelSupportsVision } from "@/server/opencode/models";
import { CURATED_MODELS, DEFAULT_CURATED_MODEL } from "@/server/models/curated";

const user = Astro.locals.user;
if (!user) {
	return Astro.redirect("/login");
}

// Get user's projects for SSR
const projects = await getProjectsByUserId(user.id);

// Get user's default model from settings
const userSettings = await db
	.select()
	.from(userSettingsTable)
	.where(eq(userSettingsTable.userId, user.id))
	.limit(1);
const settingsDefaultModel = userSettings[0]?.defaultModel;

// Get connected provider IDs
const connectedProviderIds = await listConnectedProviderIds();

// Enrich all curated models with vision support data and availability status
const enrichedModels = await Promise.all(
	CURATED_MODELS.map(async (model) => {
		const modelId: string = String(model.id);
		const providerId: string = modelId.split("/")[0] || "";
		const isAvailable = connectedProviderIds.includes(providerId);
		const visionSupport = await modelSupportsVision(modelId);

		return {
			id: modelId,
			name: model.name,
			provider: model.provider,
			tier: model.tier,
			supportsImages: visionSupport || model.supportsImages,
			available: isAvailable,
			unavailableReason: !isAvailable
				? `Connect ${model.provider} API key in Settings to use this model`
				: (undefined as any),
		};
	}),
);

// Get first available model for default
const firstAvailableModel = enrichedModels.find((m) => m.available);

// Determine default model: use settings default if it's available, otherwise use first available, otherwise fall back to DEFAULT_CURATED_MODEL
const defaultModel = (() => {
	if (
		settingsDefaultModel &&
		enrichedModels.some((m) => m.id === settingsDefaultModel)
	) {
		return settingsDefaultModel;
	}
	return firstAvailableModel?.id ?? DEFAULT_CURATED_MODEL;
})();
---

<AppLayout title="Dashboard">
  <HeroSection>
    <CreateProjectForm client:load models={enrichedModels} defaultModel={defaultModel} />
  </HeroSection>

  <ProjectsList fallback={projects} client:load />
</AppLayout>

---
import AppLayout from "@/layouts/AppLayout.astro";
import HeroSection from "@/components/dashboard/HeroSection.astro";
import { CreateProjectForm } from "@/components/dashboard/CreateProjectForm";
import { ProjectCard } from "@/components/projects/ProjectCard";
import { getProjectsByUserId } from "@/server/projects/projects.model";
import { AVAILABLE_MODELS, DEFAULT_MODEL } from "@/server/settings/openrouter";
import { db } from "@/server/db/client";
import { userSettings as userSettingsTable } from "@/server/db/schema";
import { eq } from "drizzle-orm";

const user = Astro.locals.user;
if (!user) {
	return Astro.redirect("/login");
}

// Get user's projects
const projects = await getProjectsByUserId(user.id);

// Get user's default model
const userSettings = await db
	.select()
	.from(userSettingsTable)
	.where(eq(userSettingsTable.userId, user.id))
	.limit(1);
const defaultModel = userSettings[0]?.defaultModel ?? DEFAULT_MODEL;
---

<AppLayout title="Dashboard">
  <HeroSection>
    <CreateProjectForm client:load models={AVAILABLE_MODELS} defaultModel={defaultModel} />
  </HeroSection>

  {projects.length > 0 && (
    <section class="container mx-auto p-8">
      <h2 class="mb-4 text-xl font-semibold">Your Projects</h2>
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="projects-grid">
        {projects.map((project) => (
          <div data-project-id={project.id}>
            <ProjectCard project={project} client:load />
          </div>
        ))}
      </div>
    </section>
  )}

  <script is:inline>
    // Make deleteProject available globally for the React component
    window.deleteProject = async function(projectId) {
      // Optimistically remove from UI
      const projectCard = document.querySelector(`[data-project-id="${projectId}"]`);
      projectCard?.classList.add('opacity-50', 'pointer-events-none');

      try {
        const response = await fetch('/_actions/projects.delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ projectId }),
        });

        if (response.ok) {
          projectCard?.remove();
        } else {
          // Revert on error
          projectCard?.classList.remove('opacity-50', 'pointer-events-none');
          throw new Error('Failed to delete project');
        }
      } catch (error) {
        projectCard?.classList.remove('opacity-50', 'pointer-events-none');
        throw error;
      }
    };
  </script>
</AppLayout>

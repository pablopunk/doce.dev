---
import AppLayout from "@/layouts/AppLayout.astro";
import { Button } from "@/components/ui/button";
import { ArrowLeft, Settings } from "lucide-react";
import { ChatPanel } from "@/components/chat/ChatPanel";
import { PreviewPanel } from "@/components/preview/PreviewPanel";
import { SetupStatusDisplay } from "@/components/setup/SetupStatusDisplay";
import { getProjectById } from "@/server/projects/projects.model";

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/login");
}

const { id, slug } = Astro.params;

if (!id) {
  return Astro.redirect("/");
}

const project = await getProjectById(id);

// Project not found or doesn't belong to user
if (!project || project.ownerUserId !== user.id) {
  return Astro.redirect("/");
}

// Redirect if slug doesn't match (canonical URL)
if (project.slug !== slug) {
  return Astro.redirect(`/projects/${project.id}/${project.slug}`);
}
---

<AppLayout title={project.name}>
  <div class="flex flex-col h-screen overflow-hidden">
    <!-- Header -->
    <header class="flex items-center justify-between px-4 py-2 border-b bg-background">
      <div class="flex items-center gap-4">
        <a href="/">
          <Button variant="ghost" size="icon" className="h-8 w-8">
            <ArrowLeft className="h-4 w-4" />
          </Button>
        </a>
        <div>
          <h1 class="text-lg font-semibold">{project.name}</h1>
          <p class="text-xs text-muted-foreground">/{project.slug}</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-muted-foreground">
          {project.model || "Default model"}
        </span>
        <a href="/settings">
          <Button variant="ghost" size="icon" className="h-8 w-8">
            <Settings className="h-4 w-4" />
          </Button>
        </a>
      </div>
    </header>

    <!-- Main content -->
    {project.setupPhase !== "completed" ? (
      <!-- Setup phase: show setup status display -->
      <SetupStatusDisplay
        projectId={project.id}
        initialSetupPhase={project.setupPhase}
        initialSetupError={project.setupError}
        client:load
      />
    ) : (
      <!-- Setup complete: show chat + preview -->
      <div class="flex-1 flex overflow-hidden" id="project-content">
        <!-- Chat panel (left) -->
        <div id="chat-container" class="w-1/2 border-r flex flex-col transition-all duration-300">
          <ChatPanel
            projectId={project.id}
            client:load
          />
        </div>

         <!-- Preview panel (right) -->
         <div id="preview-container" class="w-1/2 flex flex-col">
           <PreviewPanel
             projectId={project.id}
             client:load
           />
         </div>
        </div>
    )}
   </div>
</AppLayout>

<script define:vars={{ projectId: project.id, initialPromptCompleted: project.initialPromptCompleted }}>
  // Poll for build status changes and update layout dynamically
  let isBuilt = initialPromptCompleted;

  async function checkBuildStatus() {
    try {
      const response = await fetch(`/api/projects/${projectId}/presence`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ viewerId: `poll_${Date.now()}` }),
      });

      if (!response.ok) return;

      const data = await response.json();
      const newBuildStatus = data.initialPromptCompleted ?? false;

      // If build status changed from false to true, update the layout
      if (!isBuilt && newBuildStatus) {
        isBuilt = true;
        updateLayout();
      }
    } catch (error) {
      console.error("Failed to check build status:", error);
    }
  }

  function updateLayout() {
    const chatContainer = document.getElementById("chat-container");
    const previewContainer = document.getElementById("preview-container");

    if (chatContainer) {
      // Update chat container classes
      chatContainer.classList.remove("w-full");
      chatContainer.classList.add("w-1/2", "border-r");
    }

    if (!previewContainer && isBuilt) {
      // Need to reload the page to render the preview component
      window.location.reload();
    }
  }

  // Only poll if not already built
  if (!isBuilt) {
    const pollInterval = setInterval(() => {
      checkBuildStatus();
      // Stop polling after a reasonable time (e.g., 10 minutes)
      if (isBuilt) {
        clearInterval(pollInterval);
      }
    }, 2000);
  }
</script>

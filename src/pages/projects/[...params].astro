---
import { ProjectContentWrapper } from "@/components/projects/ProjectContentWrapper";
import { SetupStatusDisplay } from "@/components/setup/SetupStatusDisplay";
import AppLayout from "@/layouts/AppLayout.astro";
import { getProjectById } from "@/server/projects/projects.model";
import { AVAILABLE_MODELS } from "@/server/settings/openrouter";

const user = Astro.locals.user;
if (!user) {
	return Astro.redirect("/login");
}

// Parse params from rest route: [id] or [id]/[slug]
const params = Astro.params.params?.split("/") ?? [];
const id = params[0];
const slug = params[1]; // undefined if only one segment

if (!id) {
	return Astro.redirect("/");
}

const project = await getProjectById(id);

// Project not found or doesn't belong to user
if (!project || project.ownerUserId !== user.id) {
	return Astro.redirect("/");
}

// Redirect if slug is provided but doesn't match (enforce canonical URL)
if (slug && slug !== project.slug) {
	return Astro.redirect(`/projects/${project.id}/${project.slug}`);
}
---

<AppLayout title={project.name}>
  <div class="flex flex-col h-full overflow-hidden">
    <!-- Main content -->
    {/* Show setup display until user prompt is complete (session.init is pre-done in template) */}
    {!project.userPromptCompleted ? (
      <!-- Setup phase: show setup status display -->
      <SetupStatusDisplay
        projectId={project.id}
        client:load
      />
    ) : (
      <!-- Setup complete: show chat + preview (with container startup overlay) -->
      <ProjectContentWrapper projectId={project.id} models={AVAILABLE_MODELS} client:load />
    )}
   </div>
</AppLayout>

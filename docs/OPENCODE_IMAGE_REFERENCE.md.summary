â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                   OPENCODE IMAGE HANDLING - EXECUTIVE SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“¸ IMAGE INPUT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Formats:     PNG, JPEG, GIF, WebP, PDF
Methods:     File picker + Paste + Drag-drop
In-Memory:   Base64 data URLs: "data:image/png;base64,iVBORw0KG..."
Storage:     Component state array
UUID:        Each image gets crypto.randomUUID() for tracking
Size Limit:  NOT enforced in UI (API providers handle it)


ğŸ“ MESSAGE STRUCTURE - WHAT GOES TO API
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Type:        File part (not text)
Format:      { type: "file", mime: "image/png", url: "data:image/png;base64,..." }
Transmitted: Base64 data URL sent directly as-is
Conversion:  Server does format-specific conversion for each API


ğŸ¨ DISPLAY IN CHAT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Location:    Above text content
Rendering:   <img src={dataUrl} />
Container:   Separate "attachments" section
Format:      Data URL works directly in <img> tags (no backend needed)


ğŸ”§ API CONVERSION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Input:       data:image/png;base64,ABC...
             â†“
Anthropic:   { type: "base64", media_type: "image/png", data: "ABC..." }
OpenAI:      { type: "image_url", image_url: { url: "data:image/png;base64,ABC..." } }
Google:      Format-specific conversion


ğŸ’¾ FILE STRUCTURE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Frontend:
  - prompt-input.tsx        (upload, paste, drag-drop logic)
  - prompt.tsx              (ImageAttachmentPart interface)
  - message-part.tsx        (display in chat history)

Backend:
  - handler.ts              (routes request)
  - anthropic.ts            (format conversion)
  - openai.ts               (format conversion)
  - provider.ts             (common format definition)


ğŸ¯ KEY PATTERNS FOR DOCE.DEV
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Use data URLs for images (proven, simple, works offline)
2. Store as array of: { type, id, filename, mime, dataUrl }
3. Display directly with <img src={dataUrl}>
4. Send base64 data URL to API
5. Do format conversion on server (not client)
6. No size limits in UI (let API handle it)
7. Keep filename & MIME type metadata
8. UUID per attachment for tracking/removal


ğŸ“‹ NO COMPRESSION/VALIDATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŒ Not done in OpenCode (and not recommended):
  - Image compression in browser
  - Auto-format conversion (PNGâ†’WebP, etc)
  - Dimension resizing
  - Content validation
  - Size pre-checking
  â†’ All delegated to API provider


âœ… WHAT TO IMPLEMENT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. FileReader.readAsDataURL() to convert files â†’ base64
2. Handle paste events â†’ extract files â†’ convert
3. Handle drag-drop â†’ extract files â†’ convert
4. Store in component state array
5. Render with <img src={dataUrl}>
6. Include in message parts when sending
7. Format conversion in server action/API handler


ğŸ“Š NO MAGIC
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Simple data structure
- No hidden processing
- Straightforward upload flow
- Format conversion is explicit and separate


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

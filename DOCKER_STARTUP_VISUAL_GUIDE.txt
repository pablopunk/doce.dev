â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   DOCKER STARTUP FAILURE - VISUAL SUMMARY                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

WHAT THE USER SEES:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "Setup timeout: starting_docker         â”‚
â”‚  exceeded 120000ms"                     â”‚
â”‚                                         â”‚
â”‚ Status: FAILED                          â”‚
â”‚ [Retry] [Delete Project]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


WHAT'S ACTUALLY HAPPENING:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker Container Status:        Queue Job Status:      Presence Manager:  â”‚
â”‚  âœ“ Preview - RUNNING (healthy)   âœ— Stuck in queue      âœ— TIMEOUT FIRED   â”‚
â”‚  âœ“ OpenCode - RUNNING (healthy)  âœ— at max attempts     âœ— Setup failed    â”‚
â”‚  âœ“ Responding to HTTP requests   âœ— Can't be claimed    âœ— Wrong timeout   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


THE BUG CHAIN (How It Breaks):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. docker.waitReady polls every 1 second
   â†“
2. Each poll = reschedule = increment attempts
   â†“
3. After 3 reschedules: attempts=3, max_attempts=3
   â†“
4. Queue can't claim job (3 < 3 is false)
   â†“
5. Job stuck in "queued" state forever
   â†“
6. Presence check fires after 2+ minutes
   â†“
7. "starting_docker" phase still shows as active
   â†“
8. Setup marked as FAILED (false positive!)


TIMELINE (What Happened With Timestamps):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
23:59:16 â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ Project created                                          â”‚
           â”‚ setup_phase: not_started                                 â”‚
           â”‚                                                           â”‚
23:59:20 â”€â”€â”¼â”€ docker.composeUp: SUCCESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
           â”‚ Containers started and healthy                          â”‚
           â”‚                                                  â”‚      â”‚
23:59:22 â”€â”€â”¼â”€ docker.waitReady: polling every 1s             â”‚      â”‚
           â”‚ Reschedule #1 (attempts: 0â†’1)                   â”‚      â”‚
           â”‚ Reschedule #2 (attempts: 1â†’2)                   â”‚      â”‚
           â”‚ Reschedule #3 (attempts: 2â†’3)                   â”‚      â”‚
00:00:22 â”€â”€â”¼â”€ Attempts maxed out â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤ Still within
           â”‚ Job STUCK (can't claim)                         â”‚      â”‚ 2 min timeout!
00:01:22 â”€â”€â”¼â”€ Present check                                  â”‚      â”‚
           â”‚ elapsed = 65 minutes  > 120 seconds    âœ— FAIL  â”€â”˜      â”‚
01:04:00 â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           Setup marked FAILED (even though it succeeded!)


THE COMPARISON: WHAT SHOULD HAPPEN vs. WHAT HAPPENS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

SHOULD MEASURE TIME FROM:                      ACTUALLY MEASURES FROM:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 23:59:22 (docker.waitReady started) â”‚        â”‚ 23:59:16 (project      â”‚
â”‚           â†“                          â”‚        â”‚  creation)             â”‚
â”‚ Poll every 1 second                  â”‚        â”‚           â†“            â”‚
â”‚ Timeout: 120 seconds                 â”‚        â”‚ Poll every 1 second    â”‚
â”‚ At 00:01:22 = PASS âœ“                â”‚        â”‚ Timeout: 120 seconds   â”‚
â”‚           â†“                          â”‚        â”‚ At 01:04:00 = FAIL âœ—   â”‚
â”‚ Services ready, marked COMPLETED    â”‚        â”‚           â†“            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ Setup failed (wrong!)   â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         Difference: 65 minutes!


THE CODE DEFECTS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

#1: Queue polling doesn't distinguish reschedule from error
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ rescheduleJob() {                    â”‚
    â”‚   attempts++  // â† WRONG!           â”‚
    â”‚   state = "queued"                  â”‚
    â”‚   runAt = now + delayMs             â”‚
    â”‚ }                                    â”‚
    â”‚                                      â”‚
    â”‚ Should track: reschedule_count      â”‚
    â”‚ Separately from: retry attempts     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

#2: Claim SQL blocks at max_attempts
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ WHERE state='queued'                 â”‚
    â”‚   AND run_at <= @now                â”‚
    â”‚   AND attempts < max_attempts        â”‚
    â”‚                  â†‘                   â”‚
    â”‚                  3 < 3 = FALSE       â”‚
    â”‚                  BLOCKED!            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

#3: Presence timeout uses creation time
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ elapsed = now - createdAt             â”‚
    â”‚                 â†‘                     â”‚
    â”‚         Measures from start          â”‚
    â”‚         NOT from phase start         â”‚
    â”‚                                      â”‚
    â”‚ Should be: setupPhaseStartedAt       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


IMPACT MATRIX:
â”â”â”â”â”â”â”â”â”â”â”â”â”

Severity: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ CRITICAL (8/10)
  - User-facing: YES (shows error)
  - Data loss: NO (containers safe)
  - Recovery: Manual delete + recreate
  - Scope: ALL new projects

Frequency: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ HIGH (8/10)
  - Happens on: All slow/loaded systems
  - Timing: Random based on load
  - Reproduction: Consistent


AFFECTED CODE FILES:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âŒ src/server/queue/queue.model.ts
   - claimNextJob() - line 417
   - rescheduleJob() - line 353

âŒ src/server/queue/queue.worker.ts
   - runJob() - lines 163-169

âŒ src/server/queue/handlers/dockerWaitReady.ts
   - handleDockerWaitReady() - lines 88-113

âŒ src/server/presence/manager.ts
   - handlePresenceHeartbeat() - line 132

âŒ src/server/db/schema.ts
   - projects table - missing setup_started_at field


DOCKER CONTAINER ACTUAL STATE:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

$ docker compose -p "doce_92a37799eec041bd7e2966b4" ps
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NAME                       â”‚ IMAGE        â”‚ STATUS               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ preview-1                  â”‚ node:22-alpine       â”‚ UP 4min (healthy)    â”‚
â”‚ opencode-1                 â”‚ node:22-slim â”‚ UP 4min (healthy)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

$ curl http://127.0.0.1:62770
HTTP/1.1 200 OK
Content-Type: text/html
â† Astro server responding

$ curl http://127.0.0.1:62771/doc
HTTP/1.1 200 OK
Content-Type: application/json
â† OpenCode API responding


SOLUTION PRIORITY:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”´ IMMEDIATE (Do first):
   - Add reschedule_count field
   - Separate it from attempts
   - Don't increment attempts on reschedule

ğŸ”´ URGENT (Do second):
   - Add setup_started_at to projects
   - Fix presence timeout time reference
   - Update queue handlers

ğŸŸ¡ HIGH (Do third):
   - Handle orphaned jobs gracefully
   - Add alerts for stuck jobs

ğŸŸ¢ MEDIUM (Do eventually):
   - Add observability/logging
   - Improve error tracking

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

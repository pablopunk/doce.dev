================================================================================
CRITICAL BUG ANALYSIS: docker.waitReady Job System Failures
================================================================================

EXECUTIVE SUMMARY
================================================================================

Two critical bugs prevent docker.waitReady from completing setup:

1. BUG #1 (ROOT CAUSE): Queue Job Polling Logic
   - Problem: Job attempts increment on every claim, causing jobs to hit
     maxAttempts and get stuck in "queued" state permanently
   - Impact: Polling jobs can only reschedule 3 times before becoming invisible
   - Severity: HIGH - Blocks all project setup
   - Complexity: LOW (3 code changes, 1 line each)

2. BUG #2 (SAFETY NET): Presence Timeout Calculation  
   - Problem: Uses project.createdAt instead of phase start time
   - Impact: Timeouts global from project creation, not per-phase
   - Severity: MEDIUM - Catches Bug #1 after 2 minutes with error
   - Complexity: LOW (2 code changes, 1 line each)

RELATIONSHIP: Bug #1 is ROOT CAUSE, Bug #2 is FALLBACK
================================================================================

Timeline:
  T=0s   → Bug #1 occurs: Job gets stuck in "queued"
  T=0-2m → Job rescheduling attempts exhaust
  T=2m   → Bug #2 triggers: Presence timeout marks phase as "failed"
  T=2m+  → User sees error after waiting 2 minutes

Must Fix Bug #1 First:
  ✓ Bug #1 is root cause preventing completion
  ✓ Bug #2 only catches symptom after delay
  ✓ Fixing just #2 only makes error appear sooner
  ✓ Fixing #1 prevents #2 from triggering

Both Are Independent:
  ✓ No conflicts between fixes
  ✓ Both necessary for reliable setup
  ✓ Can fix in sequence or together


DETAILED ANALYSIS: BUG #1 - Queue Job Polling Logic
================================================================================

CURRENT BROKEN FLOW:

  1. claimNextJob() called
     → attempts increments: 1→2 (line 412)
     → state = "running"
     → Job locked to worker

  2. Handler checks if services ready
     → Services not ready (Docker still starting)
     → Calls ctx.reschedule(POLL_DELAY_MS)
     → Throws RescheduleError

  3. Queue worker catches RescheduleError
     → Calls rescheduleJob()
     → state → "queued"
     → attempts STAYS at 2 ← PROBLEM!

  4. Next poll cycle
     → claimNextJob() tries to claim again
     → attempts increments: 2→3
     → state = "running"

  5. Services still not ready
     → Reschedule again
     → attempts stays at 3

  6. Next poll cycle
     → claimNextJob() WHERE clause checks: attempts < maxAttempts
     → Evaluates: 3 < 3 = FALSE
     → Query returns NULL
     → Job NEVER CLAIMED AGAIN

  7. Job Stuck Forever
     → state = "queued"
     → attempts = 3 (equals maxAttempts)
     → setupPhase stays "starting_docker"
     → User sees setup spinner indefinitely


THE CORE PROBLEM:

  rescheduleJob() doesn't decrement attempts (line 353-373):
  
    ```typescript
    // Note: attempts is NOT decremented - it was already incremented on claim.
    // But we don't set lastError, so this looks like a normal reschedule.
    ```
  
  This works for ERROR retries but BREAKS for POLLING:
  
    ERROR retry: Inc on claim + inc on error = track failures ✓
    POLLING:     Inc on claim + reschedule = consumes budget ✗
  
  Polling should NOT consume attempts budget!


FILES REQUIRING CHANGES:

  File: src/server/queue/queue.model.ts (lines 353-373)
    Change: Add attempts: sql`attempts - 1` to rescheduleJob()
    Why: Polling reschedulules shouldn't consume attempt budget

  File: src/server/queue/enqueue.ts (lines 68-81)
    Change: Set maxAttempts: 300 for docker.waitReady
    Why: Allow ~5 minutes of 1-second polls (300 reschedules)

  File: src/server/queue/enqueue.ts (lines 133-143)
    Change: Set maxAttempts: 300 for opencode.waitIdle
    Why: Allow ~10 minutes of 2-second polls


IMPACT ON OTHER JOBS:

  Affected (Polling):
    ✗ docker.waitReady - BROKEN (can only reschedule 3 times)
    ✗ opencode.waitIdle - BROKEN (can only reschedule 3 times)
    ✗ Any future polling jobs - BROKEN

  Unaffected (Error-Retry):
    ✓ project.create - Works normally
    ✓ docker.composeUp - Works normally
    ✓ project.delete - Works normally
    ✓ All others - Works normally

  After Fix:
    ✓ Polling jobs can reschedule indefinitely
    ✓ Error-retry jobs still respect maxAttempts
    ✓ No breaking changes


EFFORT: 2-4 hours (implementation + testing)


DETAILED ANALYSIS: BUG #2 - Presence Timeout
================================================================================

CURRENT BROKEN FLOW:

  Presence timeout calculated in presence/manager.ts (line 132):
  
    ```typescript
    const elapsed = Date.now() - project.createdAt.getTime();
    ```
  
  This uses project.createdAt = when user submitted form
  Should use setupStartedAt = when phase actually started
  But setupStartedAt is always NULL (never updated)!


CONCRETE SCENARIO - User Creates Project But Doesn't Check:

  T=0s:    Project created (createdAt = T0)
           setupPhase = "not_started"
           setupStartedAt = NULL

  T=0s:    Queue jobs auto-start in background

  T=120s:  User opens project page (presence heartbeat)
           elapsed = 120s - 0s = 120s
           phaseTimeout = 120s for "starting_docker"
           
           Timeout triggers: 120 >= 120 = TRUE
           Phase marked "failed"
           
           BUT: Docker containers are only 95% ready!
           Just needed 10 more seconds!
           User sees error unnecessarily


SCENARIO - setupStartedAt Isn't Updated:

  T=0s:    Project created
           setupPhase = "not_started"

  T=1s:    docker.composeUp handler runs
           Sets: setupPhase = "starting_docker"
           ✗ Does NOT update setupStartedAt!

  T=120s:  User checks presence
           Uses: project.createdAt (T=0s)
           Calculated elapsed = 120s
           
           Should be:
           Uses: setupStartedAt (should be T=1s)
           Calculated elapsed = 119s
           
           This 1-second difference becomes minutes in real scenarios


ROOT CAUSE:

  setupStartedAt column exists in schema but is NEVER SET:
  
    - Not initialized in createProject()
    - Not updated in updateProjectSetupPhase()
    - Always NULL
  
  Present timeout calculation falls back to createdAt (wrong!)


FILES REQUIRING CHANGES:

  File: src/server/projects/projects.model.ts (lines 170-178)
    Change: Add setupStartedAt: new Date() to updateProjectSetupPhase()
    Why: Track when each phase started for per-phase timeouts

  File: src/server/presence/manager.ts (lines 129-145)
    Change: Use setupStartedAt instead of createdAt
    Why: Calculate timeout from phase start, not project creation
    
    From: const elapsed = Date.now() - project.createdAt.getTime();
    To:   const startTime = project.setupStartedAt?.getTime() ?? project.createdAt.getTime();
          const elapsed = Date.now() - startTime;


IMPACT ON TIMEOUTS:

  Before (WRONG - Global from project creation):
    Project.createdAt = T0
    Phase starts at T0 + 30s
    User checks at T0 + 120s
    Elapsed = 120s (includes 30s before phase!)
    Can timeout prematurely

  After (CORRECT - Per-phase):
    Phase starts at T0 + 30s
    User checks at T0 + 120s
    Elapsed = 90s (from phase start)
    More accurate timeout


COMPATIBILITY:

  ✓ No database schema changes (setupStartedAt already exists)
  ✓ No breaking changes
  ✓ Backwards compatible (uses ?? operator for NULL)
  ✓ Improves accuracy without side effects


EFFORT: 2-4 hours (implementation + testing)


COMPARISON TABLE
================================================================================

                        BUG #1                  BUG #2
-------------------------------------------------------------------
Issue               Polling gets stuck      Timeout uses wrong time
Root Cause          No attempt decrement    setupStartedAt not updated
Location            queue.model.ts          presence/manager.ts
                    enqueue.ts              projects.model.ts
-------------------------------------------------------------------
Severity            HIGH                    MEDIUM
Impact              Blocks setup            Catches symptom
-------------------------------------------------------------------
Files to Change     3                       2
Lines to Change     ~5 total                ~3 total
-------------------------------------------------------------------
Complexity          LOW                     LOW
Implementation      1-2 hours               1-2 hours
Testing             1-2 hours               1-2 hours
-------------------------------------------------------------------
Break Other Jobs?   NO (independent)        NO (independent)
Breaking Changes?   NO                      NO
Schema Changes?     NO                      NO
-------------------------------------------------------------------
Must Fix First?     YES - Root cause        AFTER - Safety net
Can Fix Together?   YES - Independent       YES - Independent
-------------------------------------------------------------------


IMPLEMENTATION CHECKLIST
================================================================================

BUG #1 - Queue Job Polling Logic

  [ ] Read: src/server/queue/queue.model.ts lines 353-373
  [ ] Edit: queue.model.ts - rescheduleJob() add attempts decrement
  [ ] Edit: enqueue.ts - docker.waitReady set maxAttempts: 300
  [ ] Edit: enqueue.ts - opencode.waitIdle set maxAttempts: 300
  [ ] Test: Create project, watch docker.waitReady job
  [ ] Verify: attempts stays at 1 during rescheduling
  [ ] Verify: setupPhase advances after services ready
  [ ] Verify: No "maxAttempts" error messages


BUG #2 - Presence Timeout

  [ ] Read: src/server/presence/manager.ts lines 128-145
  [ ] Read: src/server/projects/projects.model.ts lines 170-178
  [ ] Edit: projects.model.ts - add setupStartedAt: new Date()
  [ ] Edit: presence/manager.ts - use setupStartedAt for timeout
  [ ] Test: Create project, check setupStartedAt value
  [ ] Verify: setupStartedAt updates on phase change
  [ ] Verify: Timeout calculated from phase start
  [ ] Verify: No premature timeouts


INTEGRATION TESTING

  [ ] Full project creation succeeds
  [ ] setupPhase progression: not_started → creating_files → starting_docker → ... → completed
  [ ] All queue jobs reach "succeeded" state
  [ ] Project status: created → starting → running
  [ ] Preview shows correct website
  [ ] Create 5 projects simultaneously
  [ ] Monitor logs for errors or warnings


EFFORT BREAKDOWN
================================================================================

Bug #1 Implementation:     1-2 hours
Bug #1 Testing:           1-2 hours
Bug #2 Implementation:     1-2 hours
Bug #2 Testing:           1-2 hours
Integration Testing:      1-2 hours
Code Review:              1 hour
---
TOTAL:                    6-11 hours (conservative)


RISK ASSESSMENT
================================================================================

Bug #1 Fix Risks:
  Severity:     LOW
  Issue:        Decrement logic straightforward
  Mitigation:   Set high maxAttempts to be safe
  Rollback:     Single line revert if needed

Bug #2 Fix Risks:
  Severity:     LOW
  Issue:        setupStartedAt column already exists
  Mitigation:   Use ?? operator for NULL safety
  Rollback:     Single line revert if needed

Combined Risk:
  Severity:     VERY LOW
  Reason:       Changes are independent, well-isolated
  Confidence:   HIGH (95%+)
  Breaking:     Minimal to none


CONCLUSION
================================================================================

WHAT'S BROKEN:
  Two independent bugs prevent docker.waitReady from completing
  Bug #1 causes jobs to get stuck
  Bug #2 catches symptom with wrong timeout calculation

SOLUTION APPROACH:
  Fix Bug #1 (root cause) first
  Then fix Bug #2 (safety net) second
  Both are low complexity, 1-2 line changes each

EXPECTED OUTCOME:
  ✓ Project setup completes successfully
  ✓ setupPhase progresses through all stages
  ✓ All queue jobs reach "succeeded" state
  ✓ Accurate per-phase timeouts
  ✓ Robust error recovery

TOTAL EFFORT:
  6-11 hours implementation + testing
  Can be completed in 1-2 development days
  Very low risk changes

PRIORITY:
  CRITICAL - Blocks all new project creation with queue-integrated setup


NEXT STEPS:
  1. Review this analysis
  2. Plan implementation schedule
  3. Fix Bug #1 (2-4 hours)
  4. Fix Bug #2 (2-4 hours)
  5. Test thoroughly
  6. Deploy with confidence

================================================================================

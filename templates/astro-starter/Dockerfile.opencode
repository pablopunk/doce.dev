FROM node:22-slim

# Install system dependencies
RUN apt-get update && apt-get install -y curl ca-certificates && rm -rf /var/lib/apt/lists/*

# Enable corepack and prepare pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# Install OpenCode
RUN curl -fsSL https://opencode.ai/install | bash -s -- --version 1.2.5

# Set up environment
ENV PATH=/root/.opencode/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

WORKDIR /app

# Expose port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=5s --timeout=5s --retries=10 --start-period=60s \
    CMD curl -f http://localhost:3000/doc || exit 1

# Start OpenCode server
CMD ["opencode", "serve", "--hostname", "0.0.0.0", "--port", "3000"]

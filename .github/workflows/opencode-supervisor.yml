name: Opencode Supervisor

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:

env:
  LOOKBACK_HOURS: 24

jobs:
  opencode-supervisor:
    runs-on: self-hosted
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Fetch recent history
        run: git fetch --shallow-since="${{ env.LOOKBACK_HOURS }} hours ago"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get recent commits
        id: commits
        run: |
          COMMITS=$(git log --since="${{ env.LOOKBACK_HOURS }} hours ago" --pretty=format:"- %h %s" 2>/dev/null || echo "")
          if [ -z "$COMMITS" ]; then
            echo "No commits in the last ${{ env.LOOKBACK_HOURS }} hours"
            echo "has_commits=false" >> $GITHUB_OUTPUT
          else
            echo "has_commits=true" >> $GITHUB_OUTPUT
            {
              echo "list<<EOF"
              echo "$COMMITS"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi

      - name: Run opencode
        if: steps.commits.outputs.has_commits == 'true'
        uses: sst/opencode/github@latest
        env:
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENCODE_PERMISSION: |
            {
              "bash": {
                "*": "deny",
                "gh issue*": "allow",
                "gh pr*": "allow",
                "git add*": "allow",
                "git commit*": "allow",
                "git push*": "allow",
                "git checkout*": "allow",
                "git branch*": "allow",
                "git status*": "allow",
                "git log*": "allow",
                "pnpm*": "allow",
                "npm*": "allow",
                "bun*": "allow"
              },
              "edit": "allow",
              "write": "allow"
            }
        with:
          model: opencode/kimi-k2.5
          prompt: |
            **STEP 1: Analyze**
            Read @AGENTS.md for project rules. Analyze commits from the last ${{ env.LOOKBACK_HOURS }} hours for style violations, bugs, or refactoring opportunities.

            **STEP 2: Check Existing**
            Verify no existing issue or PR already addresses these. If yes, exit silently.

            **STEP 3: Create Deliverable**
            Bundle ALL improvements into a SINGLE PR:
            - IF confident: `git checkout -b refactor/supervisor-[date]`, implement, commit, push, `gh pr create`
            - IF needs discussion: Create issue with analysis
            - IF no improvements found: Exit silently

            **RULES:**
            - ONE PR with bundled changes only
            - Check for duplicates first

name: PR Review

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  opencode-review:
    if: |
      (github.event_name == 'pull_request' && !github.event.pull_request.draft) ||
      (github.event.issue.pull_request &&
       startsWith(github.event.comment.body, '/review') &&
       contains(fromJson('["OWNER","MEMBER"]'), github.event.comment.author_association))
    runs-on: self-hosted
    permissions:
      contents: write
      pull-requests: write
      id-token: write
      issues: read

    steps:
      - name: Get PR number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate random HOME directory
        id: random-home
        run: |
          RANDOM_SUFFIX=$(cat /dev/urandom | tr -dc 'a-z0-9' | fold -w 12 | head -n 1)
          echo "home=/tmp/github-home-${{steps.pr-number.outputs.number}}-${RANDOM_SUFFIX}" >> "$GITHUB_OUTPUT"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Run opencode
        uses: sst/opencode/github@latest
        env:
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOME: ${{steps.random-home.outputs.home}}   # This is necessary for the self-hosted runner
          OPENCODE_PERMISSION: |
            {
              "bash": {
                "*": "deny",
                "gh*": "allow",
                "gh pr review*": "deny"
              }
            }
        with:
          model: opencode/kimi-k2.5
          prompt: |
            **PR #${{ steps.pr-number.outputs.number }}**

            **STEP 1: Fetch Changes**
            Get PR diff and changed files using gh CLI.

            **STEP 2: Review**
            Read changed files (not just diff) for context. Check against @AGENTS.md for:
            - Style guide violations
            - Potential bugs
            - Missing error handling

            **STEP 3: Post Comments**
            For each issue, create PR line comment:
            ```
            gh api --method POST -H "Accept: application/vnd.github+json" /repos/${{ github.repository }}/pulls/${{ steps.pr-number.outputs.number }}/comments -f 'body=[desc]' -f 'commit_id=[sha]' -f 'path=[file]' -F "line=[n]" -f 'side=RIGHT'
            ```

            **STEP 4: Summary**
            IF issues found: Provide review summary
            IF no issues: `./scripts/upsert-pr-comment.sh "<!-- doce-review-status -->" "âœ… LGTM" "${{ steps.pr-number.outputs.number }}"`

            **RULES:**
            - Only comment on actual violations
            - Verify suggested fixes are syntactically valid
            - Prefer comments over code suggestions when uncertain
            - Never post multiple LGTM comments


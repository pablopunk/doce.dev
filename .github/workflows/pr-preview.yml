name: PR Preview Environment

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

jobs:
  deploy:
    name: Deploy PR Preview
    runs-on: self-hosted
    if: |
      github.event.pull_request.head.repo.full_name == github.repository &&
      github.event.action != 'closed'
    permissions:
      contents: read
      pull-requests: write
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Check if Dockerfile changed
        id: dockerfile-check
        run: |
          if git diff origin/main...HEAD -- Dockerfile | grep -q .; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Dockerfile has changes, will rebuild image"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "Dockerfile unchanged, will reuse main branch image"
          fi

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Extract PR number
        id: pr
        run: echo "number=${{ github.event.number }}" >> "$GITHUB_OUTPUT"

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H doce.pangolin-frog.ts.net >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy preview
        id: deploy
        run: |
          set -e
          PR_NUM=${{ steps.pr.outputs.number }}
          VM_HOST="doce.pangolin-frog.ts.net"
          SSH_USER="root"
          PR_DIR="/root/previews/pr-$PR_NUM"
          REPO_DIR="$PR_DIR/repo"
          SCRIPTS_DIR="/root/previews/scripts"

          echo "üöÄ Deploying PR #$PR_NUM to $VM_HOST"

          # Step 1: Clean up stale previews for closed PRs
          echo "üßπ Cleaning up stale previews..."
          
          # Get list of open PR numbers from GitHub
          OPEN_PRS=$(gh pr list --state open --json number --jq '.[].number')
          
          # Get list of existing PR directories on server
          EXISTING_DIRS=$(ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" \
            "ls -d /root/previews/pr-* 2>/dev/null | xargs -n1 basename 2>/dev/null || true")
          
          # For each existing directory, check if the PR is still open
          for dir in $EXISTING_DIRS; do
            DIR_PR_NUM=$(echo "$dir" | sed 's/pr-//')
            IS_OPEN=false
            for open_pr in $OPEN_PRS; do
              if [ "$DIR_PR_NUM" = "$open_pr" ]; then
                IS_OPEN=true
                break
              fi
            done
            
            if [ "$IS_OPEN" = "false" ]; then
              echo "üóëÔ∏è  Cleaning up stale preview for PR #$DIR_PR_NUM (PR is closed)"
              ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" \
                "cd /root/previews/$dir && docker-compose down 2>/dev/null || true"
              ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" \
                "$SCRIPTS_DIR/release-port.sh $DIR_PR_NUM 2>/dev/null || true"
              ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" \
                "docker rmi -f doce-pr-$DIR_PR_NUM:latest 2>/dev/null || true"
              ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" \
                "rm -rf /root/previews/$dir"
            fi
          done
          
          # Also clean up any leftover containers from previous runs of this PR
          echo "üì¶ Cleaning up stale containers for PR #$PR_NUM..."
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" \
            "docker rm -f doce-pr-$PR_NUM 2>/dev/null || true; cd /root/previews && for dir in pr-*; do [ -d \"\$dir\" ] && (cd \"\$dir\" && docker-compose down 2>/dev/null || true) || true; done"

          # Step 2: Create PR directory
          echo "üìÅ Creating PR directory..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@$VM_HOST "mkdir -p $PR_DIR \"$REPO_DIR\""

           # Step 2.5: Remove old containers to force container recreation
           echo "üßπ Stopping old containers to pick up new template..."
           ssh -o StrictHostKeyChecking=no $SSH_USER@$VM_HOST \
             "cd $PR_DIR && docker-compose down 2>/dev/null || true"

           # Step 2.75: Ensure global pnpm volume exists
           echo "üì¶ Ensuring global pnpm volume exists..."
           ssh -o StrictHostKeyChecking=no $SSH_USER@$VM_HOST \
             "docker volume create doce-global-pnpm-store 2>/dev/null || true"

            # Step 3: Copy PR code to VM via tar
           echo "üìã Copying PR code..."
           tar czf - --exclude=node_modules --exclude=.git --exclude=dist --exclude=data . | \
             ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" "cd \"$REPO_DIR\" && tar xzf -"

          # Step 4: Allocate port
          echo "üîå Allocating port..."
          PORT=$(ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" "$SCRIPTS_DIR/allocate-port.sh $PR_NUM")
          echo "Allocated port: $PORT"

          # Step 5: Prepare Docker image
          DOCKERFILE_CHANGED="${{ steps.dockerfile-check.outputs.changed }}"

          if [ "$DOCKERFILE_CHANGED" = "true" ]; then
            echo "üî® Building Docker image (Dockerfile changed)..."
            echo "‚è±Ô∏è Build started at $(date)"
            ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" \
              "cd \"$REPO_DIR\" && DOCKER_BUILDKIT=1 docker build -t doce-pr-$PR_NUM:latest ."
            echo "‚è±Ô∏è Build completed at $(date)"
          else
            echo "üì• Pulling pre-built image from registry (Dockerfile unchanged)..."
            ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" \
              "docker pull ghcr.io/${{ github.repository_owner }}/doce.dev:latest && \
               docker tag ghcr.io/${{ github.repository_owner }}/doce.dev:latest doce-pr-$PR_NUM:latest"
          fi

          # Step 6: Generate compose file from template
          echo "üìù Generating docker-compose.yml..."
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" \
            "cd \"$REPO_DIR\" && PR_NUM=$PR_NUM PORT=$PORT envsubst < docker-compose.preview.yml > \"$PR_DIR/docker-compose.yml\""

          # Step 7: Start preview environment with docker-compose
          echo "‚ñ∂Ô∏è  Starting preview environment on port $PORT..."
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" \
            "cd \"$PR_DIR\" && docker-compose up -d"

          # Step 8: Wait for app to be healthy
          echo "‚è≥ Waiting for app to start..."
          for i in {1..60}; do
            if ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" \
              "curl -f http://localhost:$PORT/ 2>/dev/null" >/dev/null 2>&1; then
              echo "‚úÖ App is healthy!"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "‚ùå App failed to start after 60 seconds"
              ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" "cd \"$PR_DIR\" && docker-compose logs app" || true
              exit 1
            fi
            echo "Waiting for app... ($i/60)"
            sleep 1
          done

          echo "‚úÖ PR preview deployed successfully!"
          echo "port=$PORT" >> "$GITHUB_OUTPUT"

      - name: Comment preview URL
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=${{ steps.pr.outputs.number }}
          PORT=${{ steps.deploy.outputs.port }}
          PREVIEW_URL="http://doce.pangolin-frog.ts.net:$PORT"
          MARKER="<!-- doce-preview-status -->"
          BODY="üöÄ **Preview deployed!**<br><br>[Open preview environment]($PREVIEW_URL)<br><br>**Note:** Accessible via Tailscale network<br><br>‚ÑπÔ∏è This preview will be automatically cleaned up when the PR is closed."

          ./scripts/upsert-pr-comment.sh "$MARKER" "$BODY" "$PR_NUM"

      - name: Comment on failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=${{ steps.pr.outputs.number }}
          MARKER="<!-- doce-preview-status -->"
          BODY="‚ùå **Preview deployment failed.**<br><br>Check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."

          ./scripts/upsert-pr-comment.sh "$MARKER" "$BODY" "$PR_NUM"

  teardown:
    name: Cleanup PR Preview
    runs-on: self-hosted
    if: github.event.action == 'closed'
    permissions:
      contents: read

    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Extract PR number
        id: pr
        run: echo "number=${{ github.event.number }}" >> "$GITHUB_OUTPUT"

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H doce.pangolin-frog.ts.net >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Stop preview
        run: |
          set -e
          PR_NUM=${{ steps.pr.outputs.number }}
          VM_HOST="doce.pangolin-frog.ts.net"
          SSH_USER="root"
          SCRIPTS_DIR="/root/previews/scripts"
          PR_DIR="/root/previews/pr-$PR_NUM"

          echo "üßπ Cleaning up PR #$PR_NUM preview"

          # Stop containers (ignore if directory doesn't exist)
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" \
            "[ -d \"$PR_DIR\" ] && cd \"$PR_DIR\" && docker-compose down 2>/dev/null || true"

          ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" "$SCRIPTS_DIR/release-port.sh $PR_NUM 2>/dev/null || true"

          ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" "docker rmi -f doce-pr-$PR_NUM:latest 2>/dev/null || true"

          ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" \
            "docker image prune -a --force 2>/dev/null || true"

          ssh -o StrictHostKeyChecking=no "$SSH_USER@$VM_HOST" "rm -rf \"$PR_DIR\" 2>/dev/null || true"

          echo "‚úÖ PR preview cleaned up!"

